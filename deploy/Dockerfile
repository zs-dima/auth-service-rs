# syntax=docker/dockerfile:1.12

# ---- Build stage ----
FROM rust:1.93-alpine AS build
WORKDIR /app

RUN apk add --no-cache musl-dev protobuf-dev ca-certificates

ARG BIN=auth-service

# Copy source and build manifests
# Note: GitHub Actions gha cache handles layer caching effectively
# For advanced dependency caching, consider cargo-chef
COPY Cargo.toml Cargo.lock ./
COPY src src
COPY crates crates
COPY api/proto api/proto
COPY api/openapi api/openapi
# COPY assets assets # Embed assets during build if needed

# Build static musl binary (lto + strip configured in Cargo.toml)
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git/db \
    --mount=type=cache,target=/app/target \
    cargo build --release --locked && \
    cp target/release/${BIN} /service

# ---- Runtime stage ----
# scratch: 0 bytes base, smallest possible image
FROM scratch

# CA certificates for TLS (required for HTTPS: gRPC, S3, Mailjet, DB)
COPY --from=build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt

COPY --from=build /service /service

# OpenAPI spec for Swagger UI (generated by `make openapi`)
COPY --from=build /app/api/openapi/v1/openapi.yaml /api/openapi/v1/openapi.yaml

# GeoIP database: Mount as volume instead of baking into image
# - MaxMind updates GeoLite2-Country weekly (Tuesdays)
# - Download: https://github.com/wp-statistics/GeoLite2-Country
# Mount to: /data/GeoLite2-Country.mmdb or copy during deployment:
# COPY --from=build /app/assets/GeoLite2-Country.mmdb /data/GeoLite2-Country.mmdb # Embed assets during build if needed

ENV RUST_LOG=info
ENV GEOIP_DB_PATH=/data/GeoLite2-Country.mmdb
# Standard path for CA certificates (used by rustls/native-tls)
ENV SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt

# Cloud Run default port (overridable via PORT or GRPC_ADDRESS env var)
EXPOSE 8080
ENTRYPOINT ["/service"]
