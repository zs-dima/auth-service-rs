syntax = "proto3";

package auth;

import "google/protobuf/empty.proto";

import "validate/validate.proto";

import "core.proto";

service AuthService {
  rpc SignIn(SignInRequest) returns (AuthInfo);
  rpc SignOut(google.protobuf.Empty) returns (core.ResultReply);
  rpc RefreshTokens(RefreshTokenRequest) returns (RefreshTokenReply);
  rpc ValidateCredentials(google.protobuf.Empty) returns (core.ResultReply);

  rpc ResetPassword(ResetPasswordRequest) returns (core.ResultReply);
  rpc SetPassword(SetPasswordRequest) returns (core.ResultReply);

  rpc LoadUsersInfo(LoadUsersInfoRequest) returns (stream UserInfo);
  rpc LoadUsers(UserId) returns (stream User);
  rpc CreateUser(CreateUserRequest) returns (core.ResultReply);
  rpc UpdateUser(UpdateUserRequest) returns (core.ResultReply);

  // Avatar management with presigned URLs (client uploads directly to S3)
  // Get a presigned URL for uploading avatar directly to S3
  rpc GetAvatarUploadUrl(GetAvatarUploadUrlRequest) returns (AvatarUploadUrl);
  // Confirm avatar upload completed
  rpc ConfirmAvatarUpload(ConfirmAvatarUploadRequest) returns (core.ResultReply);
  // Delete user avatar from S3
  rpc DeleteUserAvatar(UserId) returns (core.ResultReply);
}

message ResetPasswordRequest {
  string email = 1 [(validate.rules).string.email = true];
}

message SetPasswordRequest {
  core.UUID user_id  = 1 [(validate.rules).message.required = true];
  string    email    = 2 [(validate.rules).string.email = true];
  string    password = 3 [(validate.rules).string.min_len = 5];
}

message SignInRequest {
  string     email           = 1 [(validate.rules).string.email = true];
  string     password        = 2 [(validate.rules).string.min_len = 5];
  core.UUID  installation_id = 3 [(validate.rules).message.required = true];
  DeviceInfo device_info     = 4 [(validate.rules).message.required = true];
}

message LoadUsersInfoRequest {
  core.UUID          user_id  = 1; // Impersonated user id
  repeated core.UUID user_ids = 2; // Optional; if empty, load all users
}

message DeviceInfo {
  core.UUID id      = 1 [(validate.rules).message.required = true];
  string    model   = 2;
  string    name    = 3;
  OsInfo    os_info = 4;
}

message OsInfo {
  string os      = 1;
  string version = 2;
}

message RefreshTokenRequest {
  string refresh_token = 1 [(validate.rules).string.min_len = 1];
}

message RefreshTokenReply {
  string refresh_token = 1;
  string access_token  = 2;
}

message AuthInfo {
  core.UUID user_id       = 1;
  string    user_name     = 2;
  UserRole  user_role     = 3;
  string    refresh_token = 4;
  string    access_token  = 5;
}

enum UserRole {
  ADMINISTRATOR = 0;
  USER          = 1;
}

message UserInfo {
  core.UUID id      = 1;
  string    name    = 2;
  string    email   = 3;
  UserRole  role    = 4;
  bool      deleted = 5;
}

message User {
  core.UUID id      = 1;
  string    name    = 2;
  string    email   = 3;
  UserRole  role    = 4;
  bool      deleted = 5;
}

// Request for presigned upload URL
message GetAvatarUploadUrlRequest {
  core.UUID user_id      = 1 [(validate.rules).message.required = true];
  string    content_type = 2 [(validate.rules).string = {in: ["image/jpeg", "image/png", "image/webp"]}];
  uint64    content_size = 3 [(validate.rules).uint64 = {gt: 0, lte: 10485760}]; // Max 10MB
}

// Response with presigned URL for direct S3 upload
message AvatarUploadUrl {
  string upload_url = 1; // Presigned PUT URL for S3
  uint64 expires_in = 2; // URL expiration in seconds
}

// Confirm avatar upload completed
message ConfirmAvatarUploadRequest {
  core.UUID user_id = 1 [(validate.rules).message.required = true];
}

message UserId {
  core.UUID id = 1 [(validate.rules).message.required = true];
}

message CreateUserRequest {
  core.UUID id       = 1 [(validate.rules).message.required = true];
  string    name     = 2 [(validate.rules).string = {min_len: 1, max_len: 255}];
  string    email    = 3 [(validate.rules).string.email = true];
  string    password = 4 [(validate.rules).string.min_len = 5];
  UserRole  role     = 5;
  bool      deleted  = 6;
}

message UpdateUserRequest {
  core.UUID id      = 1 [(validate.rules).message.required = true];
  string    name    = 2 [(validate.rules).string = {min_len: 1, max_len: 255}];
  string    email   = 3 [(validate.rules).string.email = true];
  UserRole  role    = 4;
  bool      deleted = 5;
}
